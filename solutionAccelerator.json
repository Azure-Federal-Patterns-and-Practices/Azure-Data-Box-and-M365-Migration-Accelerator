{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "9.0.0.0",
    "parameters": {

        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "<Enter the name-of-your-vnet>",
            "metadata": {
                "description": "The name of the Hub virtual network provisioned for the deployment"
            }
        },
        "addressPrefix": {
            "type": "string",
            "defaultValue": "10.230.0.0/21",
            "metadata": {
                "description": "Hub Virtual Network address CIDR."
            }
        },
        
        "JumpHostSubnetName": {
            "type": "string",
            "defaultValue": "JUMPHOST-SUBNET",
            "metadata": {
                "description": "Jump Host Subnet "
            }
        },
        "PrivateEndpointSubnetName": {
            "type": "string",
            "defaultValue": "PRIVATE-ENDPOINT-SUBNET",
            "metadata": {
                "description": "Private Endpoint Subnet for Storage"
            }
        },
        
        "JumpHostSubnetPrefix": {
            "type": "string",
            "defaultValue": "10.230.0.0/24",
            "metadata": {
                "description": "Enter the CIDR address for the JUMP Host Subnet"
            }
        },
        "BastionSubnetPrefix": {
            "type": "string",
            "defaultValue": "10.230.1.0/27",
            "metadata": {
                "description": "CIDR address for the Azure Bastion subnet must be a /27"
            }
        },
        "PrivateEndpointSubnetPrefix": {
            "type": "string",
            "defaultValue": "10.230.2.0/27",
            "metadata": {
                "description": "CIDR address for the Azure Bastion subnet must be a /27"
            }
        },
        "GatewaySubnetPrefix": {
            "type": "string",
            "defaultValue": "10.230.3.0/27",
            "metadata": {
                "description": "CIDR address for the GatewaySubnet subnet must be a /27"
            }
        },
        "BastionPIP1": {
            "type": "string",
            "defaultValue": "<Enter a unique name for your Bastion PIP>",
            "metadata": {
                "description": "Azure BastionHost Public IP"
            }
        },
        "Bastionnstancename": {
            "type": "string",
            "defaultValue": "<Enter a unique name for your BastionHost>",
            "metadata": {
                "description": "BastionHost Instance Name"
            }
        },
        "StorageAccountName": {
            "type": "string",
            "defaultValue": "<Enter your storage account name here>",
            "metadata": {
                "description": "Name of the migration storage account. Must not be more than 24 characters, no special characters, and lowercase"
            }
        },
        "minimumTlsVersion": {
            "type": "string",
            "defaultValue": "TLS1_2",
            "allowedValues": [
                "TLS1_1",
                "TLS1_2"
            ],
            "metadata": {
                "description": "Minimum TLS Version. Recommended TLS 1.2"
            }
        },
        "supportsHttpsTrafficOnly": {
            "type": "bool",
            "metadata": {
                "description": "Allow only HTTPS traffic to the storage account"
            }
        },
        "allowBlobPublicAccess": {
            "type": "bool",
            "metadata": {
                "description": "Public access to the blob RECOMMENDATION IS NO"
            }
        },
        "allowSharedKeyAccess": {
            "type": "bool"
        },
        "allowCrossTenantReplication": {
            "type": "bool",
            "metadata": {
                "description": "Set this to false unless you want to replicate outside your Azure tenant"
            }
        },
        "defaultOAuth": {
            "type": "bool",
            "metadata": {
                "description": "Set this to true to allow Azure Active Directory authentication"
            }
        },
        
        "largeFileSharesState": {
            "type": "string",
            "defaultValue": "enabled",
            "metadata": {
                "description": "Enable large share support, recommendation is set to enabled"
            }
        },

        "isShareSoftDeleteEnabled": {
            "type": "bool",
            "metadata": {
                "description": "Soft delete protection. Recommended"
            }
        },

        "VMSize" : {
           "type": "string",
            "allowedValues" : [
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_D4as_v4"
            ],
            "metadata": {
                "description": "VM Size for the Migration  Server"
            }
        
        },
        "VMName": {
            "type": "string",
            "defaultValue": "M365-MIGVM",
            "metadata": {
                "description": "Basic name pattern of vm not more than 15 characters we are appending the numerical number at end of the vm"
            }
        },

        "VMInstances": {
            "type": "int",
            "defaultValue": "2",
            "metadata": {
                "description": "Number of Migration Computers Needed"
            }
        },
    
            "Username": {
                "type": "string",
                "defaultValue": "xadmin",
                "metadata": {
                    "description": "Administrative Account"
                }

            },
            "Password": {
                "type": "securestring",
                "metadata": {
                    "description": "Administrative Password"
                }
            }
        


    },
    "functions": [],
    "variables": {},
    "resources": [
        {
            "name": "NSG-01",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2018-08-01",
            "location": "[resourceGroup().location]",
            "properties": {
                "securityRules": [
                    {
                        "name": "RDPnsgRule",
                        "properties": {
                            "description": "description",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 100,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },

        {
            "name": "[parameters('storageAccountName')]",
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2021-06-01",
            "location": "[resourceGroup().location]",
            "kind": "FileStorage",
            "sku": {
                "name": "Premium_LRS",
                "tier": "Premium"
            },

            "properties": {
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "supportsHttpsTrafficOnly": "[parameters('supportsHttpsTrafficOnly')]",
                "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                "allowSharedKeyAccess": "[parameters('allowSharedKeyAccess')]",
                "allowCrossTenantReplication": "[parameters('allowCrossTenantReplication')]",
                "defaultToOAuthAuthentication": "[parameters('defaultOAuth')]",
                "networkAcls": {
                    "bypass": "AzureServices",
                    "defaultAction": "Allow",
                    "ipRules": []
                },
                "largeFileSharesState": "[parameters('largeFileSharesState')]"

            }             
           
        },
        {
            "name": "[concat(parameters('storageAccountName'), '/default')]",
            "type": "Microsoft.Storage/storageAccounts/fileservices",
            "apiVersion": "2021-06-01",
            "properties": {
                "shareDeleteRetentionPolicy": {
                    "enabled": "[parameters('isShareSoftDeleteEnabled')]"

                }
            },
            "dependsOn": [
                "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]"
            ]
        },

        {
            "name": "[parameters('virtualNetworkName')]",
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-11-01",
            "location": "[resourceGroup().location]",
             "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', 'NSG-01')]"
            ],
            "tags": {
                "displayName": "[parameters('virtualNetworkName')]"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[parameters('addressPrefix')]"
                    ]
                },
                
                "subnets": [
                    {
                        "name": "AzureBastionSubnet",
                        "properties": {
                            "addressPrefix": "[parameters('BastionSubnetPrefix')]"
                        }
                    },
                    {
                        "name": "[parameters('JumpHostSubnetName')]",
                        "properties": {
                            "addressPrefix": "[parameters('JumpHostSubnetPrefix')]",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'NSG-01')]"
                                
                            }
                        }
                    },
                    {
                        "name": "[parameters('PrivateEndpointSubnetName')]",
                        "properties": {
                            "addressPrefix": "[parameters('PrivateEndpointSubnetPrefix')]"
                            
                        }
                    },
                    {
                        "name": "GatewaySubnet",
                        "properties": {
                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]"
                            
                        }
                    }
                ]




            }
        },
        {
            "apiVersion": "2020-05-01",
            "type": "Microsoft.Network/publicIpAddresses",
            "name": "[parameters('BastionPIP1')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAllocationMethod": "Static"
            }
        },
        {
            "apiVersion": "2020-05-01",
            "type": "Microsoft.Network/bastionHosts",
            "name": "[parameters('Bastionnstancename')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIpAddresses', parameters('BastionPIP1'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"

            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "IpConf",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), 'AzureBastionSubnet')]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIpAddresses', parameters('BastionPIP1'))]"
                            }
                        }
                    }
                ]
            }
        },
        

        {
            "name": "[concat(parameters('VMName'),'-NIC-',copyIndex(1))]",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-11-01",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "nicLoop",
                "count": "[parameters('VMInstances')]"
            },
             "dependsOn": [

                "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
            ],
            "tags": {
                "displayName": "[concat(parameters('VMName'),'-NIC-',copyIndex(1))]"
            },
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipConfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('JumpHostSubnetName'))]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "name": "[concat(parameters('VMName'),'-',copyIndex(1))]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "vmLoop",
                "count": "[parameters('VMInstances')]"
            },
            "dependsOn": [

                "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('VMName'),'-NIC-',copyIndex(1)))]"
            ],
            "tags": {
                "displayName": "[concat(parameters('VMName'),copyIndex(1))]"
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('VMSize')]"
                },
                "osProfile": {
                    "computerName": "[concat(parameters('VMName'),'-',copyIndex(1))]",
                    "adminUsername": "[parameters('Username')]",
                    "adminPassword": "[parameters('Password')]"

                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Windows",
                        "name": "[concat(parameters('VMName'),copyIndex(1),'-OSDISK')]",
                        "caching": "ReadWrite",
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "Standard_LRS"

                        },
                        "diskSizeGB": 127

                    },
                    "dataDisks": []
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('VMName'),'-NIC-',copyIndex(1)))]"
                        }
                    ]
                }

            }
        }




    ],
    "outputs": {}
}